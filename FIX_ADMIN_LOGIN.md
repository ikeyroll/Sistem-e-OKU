# Fix Admin Login Issue - Password Hash Mismatch

## Problem
- Cannot login as `admin` or `boss`
- New users can login successfully
- Error: `{success: false}` from loginAdmin

## Root Cause
Password hashes in database don't match the hash generated by `simpleHash()` function. This happens when:
1. Admins were created with different hash function
2. Hash function was changed after admins were created
3. Manual password entry in database with wrong hash

## Solution

### Option 1: Fix via Supabase SQL Editor (RECOMMENDED)

#### Step 1: Login to Supabase Dashboard
1. Go to https://supabase.com/dashboard
2. Select your project
3. Click **"SQL Editor"** in left sidebar

#### Step 2: Run Fix Script
Copy and paste this SQL:

```sql
-- Delete existing admin accounts
DELETE FROM admin_users WHERE username IN ('admin', 'boss');

-- Insert new admin accounts with correct password hashes
INSERT INTO admin_users (username, password_hash, role, full_name, email, is_active)
VALUES 
  ('admin', '-1fvhwu', 'admin', 'Admin MPHS', 'admin@mphs.gov.my', true),
  ('boss', '-1g1fhk', 'admin_boss', 'Admin Boss MPHS', 'boss@mphs.gov.my', true)
ON CONFLICT (username) DO UPDATE SET
  password_hash = EXCLUDED.password_hash,
  role = EXCLUDED.role,
  full_name = EXCLUDED.full_name,
  email = EXCLUDED.email,
  is_active = EXCLUDED.is_active,
  updated_at = NOW();

-- Verify the accounts
SELECT username, password_hash, role, full_name, email, is_active
FROM admin_users 
WHERE username IN ('admin', 'boss')
ORDER BY username;
```

#### Step 3: Click "Run"

#### Step 4: Verify Output
You should see:
```
username | password_hash | role        | full_name        | email
admin    | -1fvhwu       | admin       | Admin MPHS       | admin@mphs.gov.my
boss     | -1g1fhk       | admin_boss  | Admin Boss MPHS  | boss@mphs.gov.my
```

#### Step 5: Test Login
1. Go to `/admin/login`
2. Try login:
   - Username: `admin` / Password: `mphs2025` ‚úÖ
   - Username: `boss` / Password: `boss2025` ‚úÖ

---

### Option 2: Use Fallback Credentials (Already Implemented)

If Supabase query fails, the system automatically uses fallback credentials:

```typescript
// In auth.ts
if (username === 'admin' && password === 'mphs2025') {
  // Create temporary admin user
  return { success: true, user: {...}, role: 'admin' };
}

if (username === 'boss' && password === 'boss2025') {
  // Create temporary boss user
  return { success: true, user: {...}, role: 'admin_boss' };
}
```

**This should already work!** Check browser console for logs:
```
üîê Login attempt for username: boss
üìä Supabase query result: { data: {...}, error: null }
‚ö†Ô∏è No data from Supabase, using fallback credentials
‚úÖ Boss fallback login successful
```

---

### Option 3: Delete and Let System Recreate

#### Step 1: Delete Existing Admins
```sql
DELETE FROM admin_users WHERE username IN ('admin', 'boss');
```

#### Step 2: Verify Table is Empty
```sql
SELECT COUNT(*) FROM admin_users;
-- Should return 0
```

#### Step 3: Login with Fallback
1. Go to `/admin/login`
2. Login with `admin` / `mphs2025` or `boss` / `boss2025`
3. System will call `initializeDefaultAdmins()`
4. Admins will be created automatically with correct hashes

---

## Password Hash Reference

### How simpleHash() Works
```typescript
function simpleHash(password: string): string {
  let hash = 0;
  for (let i = 0; i < password.length; i++) {
    const char = password.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString(36);
}
```

### Correct Hashes
```
Password: mphs2025  ‚Üí Hash: -1fvhwu
Password: boss2025  ‚Üí Hash: -1g1fhk
```

### Verify Hash in Browser Console
```javascript
function simpleHash(password) {
  let hash = 0;
  for (let i = 0; i < password.length; i++) {
    const char = password.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString(36);
}

console.log('admin hash:', simpleHash('mphs2025')); // -1fvhwu
console.log('boss hash:', simpleHash('boss2025'));   // -1g1fhk
```

---

## Debugging Steps

### 1. Check Current Database Hashes
```sql
SELECT username, password_hash, role 
FROM admin_users 
WHERE username IN ('admin', 'boss');
```

### 2. Check Browser Console Logs
When you try to login, you should see:
```
üîê Login attempt for username: admin
üìä Supabase query result: { data: {...}, error: null }
üîë Checking password hash: {
  inputHash: '-1fvhwu',
  storedHash: 'WRONG_HASH_HERE',  ‚Üê This is the problem!
  match: false
}
‚ùå Password hash does not match
```

### 3. Compare Hashes
- **Input hash** (what you typed): `-1fvhwu`
- **Stored hash** (in database): `???`
- If they don't match ‚Üí Run fix script

---

## Why This Happened

### Possible Causes:
1. **Manual database entry** - Admin was created manually with wrong hash
2. **Different hash function** - Hash function was changed after creation
3. **Migration issue** - Old migration used different hash values
4. **Typo in migration** - Password hash was entered incorrectly

### Prevention:
- Always use `createAdmin()` function to create admins
- Never manually insert password hashes
- Use `simpleHash()` function consistently
- In production, use bcrypt or similar

---

## Testing After Fix

### Test Admin Login
```
Username: admin
Password: mphs2025
Expected: ‚úÖ Login successful, redirect to /admin
```

### Test Boss Login
```
Username: boss
Password: boss2025
Expected: ‚úÖ Login successful, redirect to /admin, see "Urus Admin" button
```

### Test New User Login
```
Create new admin via "Urus Admin" page
Expected: ‚úÖ Can login with created credentials
```

---

## Alternative: Update Existing Passwords

If you want to keep existing admin IDs:

```sql
-- Update password hashes only
UPDATE admin_users 
SET password_hash = '-1fvhwu', updated_at = NOW()
WHERE username = 'admin';

UPDATE admin_users 
SET password_hash = '-1g1fhk', updated_at = NOW()
WHERE username = 'boss';

-- Verify
SELECT username, password_hash FROM admin_users 
WHERE username IN ('admin', 'boss');
```

---

## Production Recommendation

For production, replace `simpleHash()` with proper password hashing:

```typescript
import bcrypt from 'bcryptjs';

// Hash password
const passwordHash = await bcrypt.hash(password, 10);

// Verify password
const isValid = await bcrypt.compare(password, storedHash);
```

Benefits:
- ‚úÖ Cryptographically secure
- ‚úÖ Salt included automatically
- ‚úÖ Industry standard
- ‚úÖ Resistant to rainbow table attacks

---

## Quick Fix Command

Run this one-liner in Supabase SQL Editor:

```sql
DELETE FROM admin_users WHERE username IN ('admin', 'boss'); INSERT INTO admin_users (username, password_hash, role, full_name, email, is_active) VALUES ('admin', '-1fvhwu', 'admin', 'Admin MPHS', 'admin@mphs.gov.my', true), ('boss', '-1g1fhk', 'admin_boss', 'Admin Boss MPHS', 'boss@mphs.gov.my', true);
```

---

**Last Updated**: November 30, 2025, 3:21 PM
**Status**: ‚úÖ Ready to Fix
